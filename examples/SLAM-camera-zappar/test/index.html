<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Storage</title>
</head>

<body>

    <!-- Input fields for video name and URL -->
    <label for="videoName">Video Name:</label>
    <input type="text" id="videoName" placeholder="Enter video name">

    <label for="videoURL">Video URL:</label>
    <input type="text" id="videoURL" placeholder="Enter video URL">

    <!-- Button to save video to IndexedDB -->
    <button id="saveVideoBtn">Save Video</button>

    <!-- Button to load and play videos from IndexedDB -->
    <button id="loadAndPlayBtn">Load & Play Videos</button>

    <!-- Button to clear all videos from IndexedDB -->
    <button id="clearVideosBtn">Clear Videos</button>

    <!-- Display messages -->
    <p id="statusMessage"></p>

    <!-- Container for video elements -->
    <div id="videoContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dbName = 'VideoDatabase';
            const dbVersion = 1;
            const objectStoreName = 'Videos';

            async function openDatabase() {
                return new Promise((resolve, reject) => {
                    // Request persistent storage
                    const indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
                    const request = indexedDB.open(dbName, { version: dbVersion, storage: 'persistent' });

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        db.createObjectStore(objectStoreName, { keyPath: 'id', autoIncrement: true });
                    };

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        resolve(db);
                    };

                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            async function saveVideo() {
                const videoName = document.getElementById('videoName').value;
                const videoURL = document.getElementById('videoURL').value;

                if (!videoName || !videoURL)
                {
                    setStatusMessage('Please enter both video name and URL.');
                    return;
                }

                try
                {
                    // Fetch the video and get its size
                    const response = await fetch(videoURL);
                    const contentLength = response.headers.get('content-length');
                    const totalSize = contentLength ? parseInt(contentLength, 10) : 0;

                    // Create a progress bar
                    const progressBar = document.createElement('progress');
                    progressBar.max = totalSize;
                    progressBar.value = 0;

                    // Add the progress bar to the status message
                    setStatusMessage(`Uploading "${videoName}": `, progressBar);

                    const videoData = await new Promise(async (resolve, reject) => {
                        const reader = response.body.getReader();
                        const chunks = [];

                        while (true)
                        {
                            const { done, value } = await reader.read();

                            if (done)
                            {
                                break;
                            }

                            chunks.push(value);

                            // Update the progress bar
                            progressBar.value += value.length;
                        }

                        const blob = new Blob(chunks, { type: response.headers.get('content-type') });
                        resolve(blob);
                    });

                    const db = await openDatabase();
                    const transaction = db.transaction([objectStoreName], 'readwrite');
                    const objectStore = transaction.objectStore(objectStoreName);

                    objectStore.add({ name: videoName, data: videoData });

                    // Remove the progress bar after upload is complete
                    progressBar.remove();

                    setStatusMessage(`Video "${videoName}" saved successfully.`);
                } catch (error)
                {
                    console.error('Error fetching or saving the video:', error);
                    setStatusMessage('Error saving the video. Please check the URL and try again.');
                }
            }

            async function loadAndPlayVideos() {
                const db = await openDatabase();
                const transaction = db.transaction([objectStoreName], 'readonly');
                const objectStore = transaction.objectStore(objectStoreName);

                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const videos = event.target.result;
                    if (videos.length === 0)
                    {
                        setStatusMessage('No videos stored.');
                        return;
                    }

                    // Clear previous video elements
                    const videoContainer = document.getElementById('videoContainer');
                    videoContainer.innerHTML = '';

                    // Create and play video elements for each stored video
                    videos.forEach((video, index) => {
                        const videoPlayer = document.createElement('video');
                        videoPlayer.controls = true;
                        videoPlayer.style.width = '100%';

                        // Create a Blob URL from the video data
                        const blobURL = URL.createObjectURL(video.data);

                        // Set the source of the video element
                        videoPlayer.src = blobURL;

                        // Append video name as an HTML element before the video
                        const videoNameElement = document.createElement('p');
                        videoNameElement.textContent = `Video Name: ${video.name}`;
                        videoContainer.appendChild(videoNameElement);

                        // Append video element to the container
                        videoContainer.appendChild(videoPlayer);

                        // Load and play the video
                        videoPlayer.load();
                        videoPlayer.play();

                        // Add a line break after each video (for better visibility)
                        if (index < videos.length - 1)
                        {
                            videoContainer.appendChild(document.createElement('br'));
                        }
                    });

                    setStatusMessage(`${videos.length} videos loaded and playing.`);
                };
            }

            async function clearVideos() {
                const db = await openDatabase();
                const transaction = db.transaction([objectStoreName], 'readwrite');
                const objectStore = transaction.objectStore(objectStoreName);

                const clearRequest = objectStore.clear();

                clearRequest.onsuccess = () => {
                    setStatusMessage('All videos cleared from IndexedDB.');
                };

                clearRequest.onerror = (event) => {
                    setStatusMessage('Error clearing videos from IndexedDB.', event.target.error);
                };
            }

            function setStatusMessage(message, additionalElement) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.innerHTML = message;
                if (additionalElement)
                {
                    statusMessage.appendChild(additionalElement);
                }
            }

            // Attach event listeners after functions are defined
            document.getElementById('saveVideoBtn').addEventListener('click', saveVideo);
            document.getElementById('loadAndPlayBtn').addEventListener('click', loadAndPlayVideos);
            document.getElementById('clearVideosBtn').addEventListener('click', clearVideos);
        });
    </script>

</body>

</html>